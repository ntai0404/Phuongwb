### Complete E2E Workflow Test
### Following RFC 2616 HTTP/1.1 Protocol
### This file demonstrates a complete end-to-end testing workflow
### VS Code REST Client Extension Required

@baseUrl = {{baseUrl}}
@recommendationUrl = {{recommendationUrl}}
@summaryUrl = {{summaryUrl}}

# Test data variables
@testUsername = e2euser
@testEmail = e2euser@example.com
@testPassword = TestPassword123!

###############################################
# STEP 1: Health Checks
###############################################

###
# Check Core API Service is running
GET {{baseUrl}}/health HTTP/1.1

###
# Check Recommendation Service is running
GET {{recommendationUrl}}/health HTTP/1.1

###
# Check Summary Service is running
GET {{summaryUrl}}/health HTTP/1.1

###############################################
# STEP 2: User Registration and Authentication
###############################################

###
# Register a new test user
# @name register
POST {{baseUrl}}/api/v1/auth/register HTTP/1.1
Content-Type: application/json

{
  "username": "{{testUsername}}",
  "email": "{{testEmail}}",
  "password": "{{testPassword}}"
}

###
# Login to get access token
# @name login
POST {{baseUrl}}/api/v1/auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "{{testUsername}}",
  "password": "{{testPassword}}"
}

###
# Extract tokens from login response
@accessToken = {{login.response.body.access_token}}
@refreshToken = {{login.response.body.refresh_token}}

###
# Verify authentication - Get current user profile
GET {{baseUrl}}/api/v1/auth/users/me HTTP/1.1
Authorization: Bearer {{accessToken}}

###############################################
# STEP 3: RSS Source Management (Admin required)
###############################################

###
# List all active RSS sources (Public)
GET {{baseUrl}}/api/v1/sources HTTP/1.1

###
# Create a new RSS source (Admin only - will fail if not admin)
# @name createSource
POST {{baseUrl}}/api/v1/sources HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "name": "Test VnExpress Source",
  "url": "https://vnexpress.net/rss/tin-moi-nhat.rss",
  "category": "News"
}

###
# Extract source ID if created successfully
@sourceId = {{createSource.response.body.id}}

###############################################
# STEP 4: Article Management
###############################################

###
# List all articles with default pagination
GET {{baseUrl}}/api/v1/articles HTTP/1.1

###
# List articles with custom pagination
GET {{baseUrl}}/api/v1/articles?page=1&per_page=5 HTTP/1.1

###
# Filter articles by source (if source exists)
GET {{baseUrl}}/api/v1/articles?source_id=1 HTTP/1.1

###
# Get specific article details (assuming article ID 1 exists)
GET {{baseUrl}}/api/v1/articles/1 HTTP/1.1

###############################################
# STEP 5: Crawler Operations (Admin required)
###############################################

###
# Get current crawler schedule
GET {{baseUrl}}/api/v1/crawler/schedule HTTP/1.1
Authorization: Bearer {{accessToken}}

###
# Trigger crawl for all active sources
POST {{baseUrl}}/api/v1/crawler/trigger HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{}

###
# Update crawler schedule to run every 6 hours
PUT {{baseUrl}}/api/v1/crawler/schedule HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "cron_schedule": "0 */6 * * *",
  "is_enabled": true
}

###############################################
# STEP 6: Recommendation Service - Index Articles
###############################################

###
# Index first article for recommendation
POST {{recommendationUrl}}/api/v1/vectors/upsert HTTP/1.1
Content-Type: application/json

{
  "id": 1001,
  "title": "Trí tuệ nhân tạo và tương lai của công nghệ",
  "content": "AI đang thay đổi cách chúng ta sống và làm việc. Từ xe tự lái đến trợ lý ảo, công nghệ AI đang ngày càng trở nên phổ biến trong cuộc sống hàng ngày."
}

###
# Index second article
POST {{recommendationUrl}}/api/v1/vectors/upsert HTTP/1.1
Content-Type: application/json

{
  "id": 1002,
  "title": "Machine Learning trong Y tế",
  "content": "Học máy đang cách mạng hóa ngành y tế với khả năng chẩn đoán bệnh chính xác hơn và phát triển thuốc nhanh hơn."
}

###
# Index third article
POST {{recommendationUrl}}/api/v1/vectors/upsert HTTP/1.1
Content-Type: application/json

{
  "id": 1003,
  "title": "Blockchain và Cryptocurrency",
  "content": "Công nghệ blockchain đang mở ra những cơ hội mới trong tài chính và nhiều lĩnh vực khác với tính bảo mật và minh bạch cao."
}

###############################################
# STEP 7: Semantic Search
###############################################

###
# Search for AI-related articles
POST {{recommendationUrl}}/api/v1/search/semantic HTTP/1.1
Content-Type: application/json

{
  "query": "trí tuệ nhân tạo và machine learning",
  "top_k": 5
}

###
# Search for healthcare articles
POST {{recommendationUrl}}/api/v1/search/semantic HTTP/1.1
Content-Type: application/json

{
  "query": "công nghệ trong y tế và chăm sóc sức khỏe",
  "top_k": 5
}

###############################################
# STEP 8: Get Similar Articles Recommendations
###############################################

###
# Get recommendations based on article 1001
GET {{recommendationUrl}}/api/v1/recommend/1001?top_k=5 HTTP/1.1

###
# Get recommendations based on article 1002
GET {{recommendationUrl}}/api/v1/recommend/1002?top_k=5 HTTP/1.1

###############################################
# STEP 9: Generate Article Summaries
###############################################

###
# Generate summary for a long Vietnamese article
POST {{summaryUrl}}/api/v1/summary/generate HTTP/1.1
Content-Type: application/json

{
  "text": "Trí tuệ nhân tạo (AI) là một trong những công nghệ đột phá nhất của thế kỷ 21. Nó đang thay đổi cách chúng ta sống, làm việc và tương tác với thế giới xung quanh. Từ các trợ lý ảo như Siri và Alexa đến xe tự lái của Tesla, AI đang ngày càng trở nên phổ biến trong cuộc sống hàng ngày. Các công ty công nghệ lớn như Google, Microsoft, và Amazon đang đầu tư hàng tỷ đô la vào nghiên cứu và phát triển AI. Trong lĩnh vực y tế, AI đang được sử dụng để chẩn đoán bệnh chính xác hơn, phát triển thuốc mới và cá nhân hóa điều trị cho từng bệnh nhân. Trong giáo dục, AI giúp tạo ra trải nghiệm học tập được cá nhân hóa cho từng học sinh. Tuy nhiên, sự phát triển của AI cũng đặt ra nhiều thách thức về đạo đức, quyền riêng tư, và tác động đến việc làm.",
  "url": "https://example.com/ai-article"
}

###
# Generate summary for English article
POST {{summaryUrl}}/api/v1/summary/generate HTTP/1.1
Content-Type: application/json

{
  "text": "Climate change represents one of the most significant challenges facing humanity in the 21st century. Rising global temperatures are causing more frequent and severe weather events, including hurricanes, droughts, floods, and wildfires. Scientists have conclusively shown that human activities, particularly the burning of fossil fuels and deforestation, are the primary drivers of climate change. The consequences are far-reaching: melting polar ice caps leading to rising sea levels, disruption of ecosystems and biodiversity loss, threats to food security, and increased risk of climate-related disasters. To address this crisis, countries around the world must work together to reduce greenhouse gas emissions, transition to renewable energy sources, and implement sustainable practices across all sectors of the economy.",
  "url": "https://example.com/climate-article"
}

###############################################
# STEP 10: Token Refresh
###############################################

###
# Refresh the access token using refresh token
# @name refreshToken
POST {{baseUrl}}/api/v1/auth/refresh HTTP/1.1
Content-Type: application/json

{
  "refresh_token": "{{refreshToken}}"
}

###
# Extract new tokens
@newAccessToken = {{refreshToken.response.body.access_token}}
@newRefreshToken = {{refreshToken.response.body.refresh_token}}

###
# Verify new token works
GET {{baseUrl}}/api/v1/auth/users/me HTTP/1.1
Authorization: Bearer {{newAccessToken}}

###############################################
# STEP 11: Error Testing
###############################################

###
# Test login with invalid credentials (should fail)
POST {{baseUrl}}/api/v1/auth/login HTTP/1.1
Content-Type: application/json

{
  "username": "invaliduser",
  "password": "wrongpassword"
}

###
# Test accessing admin endpoint without admin role (should fail)
POST {{baseUrl}}/api/v1/sources HTTP/1.1
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "name": "Unauthorized Source",
  "url": "https://example.com/rss",
  "category": "Test"
}

###
# Test summary with too short text (should fail)
POST {{summaryUrl}}/api/v1/summary/generate HTTP/1.1
Content-Type: application/json

{
  "text": "Too short",
  "url": "https://example.com/short"
}

###
# Test getting non-existent article (should return 404)
GET {{baseUrl}}/api/v1/articles/99999 HTTP/1.1

###############################################
# TEST COMPLETED
# Review all responses to verify functionality
###############################################
